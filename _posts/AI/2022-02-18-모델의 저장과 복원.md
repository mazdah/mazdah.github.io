---
layout: article
title: Tensorflow Tutorial 8
excerpt: ëª¨ë¸ ì €ì¥ê³¼ ë³µì›
mathjax: true
tags:
- [AI, ML, Tensorflow, tutorial, ëª¨ë¸ ì €ì¥, ëª¨ë¸ ë³µì›, SavedModel, HDF5]
categories: AI
comments: true
header:
  theme: dark
  background: 'linear-gradient(135deg, rgb(34, 139, 87), rgb(139, 34, 139))'
article_header:
  type: overlay
  theme: dark
  background_color: '#203028'
  background_image:
    gradient: 'linear-gradient(135deg, rgba(34, 139, 87 , .4), rgba(139, 34, 139, .4))'
    src: /ai.jpg
---

# ëª¨ë¸ ì €ì¥ê³¼ ë³µì›

- ëª¨ë¸ì˜ ì €ì¥
  - ê¸´ í›ˆë ¨ ì‹œê°„ì„ í”¼í•  ìˆ˜ ìˆìŒ
  - ëª¨ë¸ì„ ê³µìœ í•  ìˆ˜ ìˆìŒ
- ê³µìœ ë˜ëŠ” ë‚´ìš©
  - ëª¨ë¸ì„ ë§Œë“œëŠ” ì½”ë“œ
  - ëª¨ë¸ì˜ í›ˆë ¨ëœ ê°€ì¤‘ì¹˜ ë˜ëŠ” íŒŒë¼ë¯¸í„°

### ì„¤ì •

#### ì„¤ì¹˜ì™€ ì„í¬íŠ¸
- pyyaml, h5py ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜ - HDF5 í¬ë§·ìœ¼ë¡œ ëª¨ë¸ì„ ì €ì¥í•˜ê¸° ìœ„í•´ì„œ í•„ìš”


```python
import os

import tensorflow as tf
from tensorflow import keras

print(tf.version.VERSION)
```

    2.7.0


#### ë°ì´í„°ì…‹ ë°›ê¸°
- MNIST ë°ì´í„°ì…‹ì„ ì´ìš©í•˜ì—¬ ëª¨ë¸ì„ ë§Œë“¤ê³  ì €ì¥
- ëª¨ë¸ì˜ ì‹¤í–‰ ì†ë„ë¥¼ ë¹ ë¥´ê²Œ í•˜ê¸° ìœ„í•´ ì²˜ìŒ 1,000ê°œë§Œ ì‚¬ìš©


```python
(train_images, train_labels), (test_images, test_labels) = tf.keras.datasets.mnist.load_data()

train_labels = train_labels[:1000]
test_labels = test_labels[:1000]

train_images = train_images[:1000].reshape(-1, 28 * 28) / 255.0
test_images = test_images[:1000].reshape(-1, 28 * 28) / 255.0
```

#### ëª¨ë¸ ì •ì˜


```python
# ê°„ë‹¨í•œ Sequential ëª¨ë¸ì„ ì •ì˜í•©ë‹ˆë‹¤
def create_model():
  model = tf.keras.models.Sequential([
    keras.layers.Dense(512, activation='relu', input_shape=(784,)),
    keras.layers.Dropout(0.2),
    keras.layers.Dense(10)
  ])

  model.compile(optimizer='adam',
                loss=tf.losses.SparseCategoricalCrossentropy(from_logits=True),
                metrics=['accuracy'])

  return model

# ëª¨ë¸ ê°ì²´ë¥¼ ë§Œë“­ë‹ˆë‹¤
model = create_model()

# ëª¨ë¸ êµ¬ì¡°ë¥¼ ì¶œë ¥í•©ë‹ˆë‹¤
model.summary()
```

    Metal device set to: Apple M1
    Model: "sequential"
    _________________________________________________________________
     Layer (type)                Output Shape              Param #
    =================================================================
     dense (Dense)               (None, 512)               401920

     dropout (Dropout)           (None, 512)               0

     dense_1 (Dense)             (None, 10)                5130

    =================================================================
    Total params: 407,050
    Trainable params: 407,050
    Non-trainable params: 0
    _________________________________________________________________


    2022-02-17 16:46:00.393796: I tensorflow/core/common_runtime/pluggable_device/pluggable_device_factory.cc:305] Could not identify NUMA node of platform GPU ID 0, defaulting to 0. Your kernel may not have been built with NUMA support.
    2022-02-17 16:46:00.395131: I tensorflow/core/common_runtime/pluggable_device/pluggable_device_factory.cc:271] Created TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:0 with 0 MB memory) -> physical PluggableDevice (device: 0, name: METAL, pci bus id: <undefined>)



---
### í›ˆë ¨í•˜ëŠ” ë™ì•ˆ ì²´í¬í¬ì¸íŠ¸ ì €ì¥í•˜ê¸°
- í›ˆë ¨í•œ ëª¨ë¸ì„ ë‹¤ì‹œ í›ˆë ¨í•  í•„ìš” ì—†ì´ ì‚¬ìš©
- ì¤‘ë‹¨í•œ ë¶€ë¶„ë¶€í„° ë‹¤ì‹œ í›ˆë ¨ì„ ì‹œì‘
- tf.keras.callbacks.ModelCheckpoint ì½œë°±ì„ ì‚¬ìš©


```python
checkpoint_path = "training_1/cp.ckpt"
checkpoint_dir = os.path.dirname(checkpoint_path)

# ëª¨ë¸ì˜ ê°€ì¤‘ì¹˜ë¥¼ ì €ì¥í•˜ëŠ” ì½œë°± ë§Œë“¤ê¸°
cp_callback = tf.keras.callbacks.ModelCheckpoint(filepath=checkpoint_path,
                                                 save_weights_only=True,
                                                 verbose=1)

# ìƒˆë¡œìš´ ì½œë°±ìœ¼ë¡œ ëª¨ë¸ í›ˆë ¨í•˜ê¸°
model.fit(train_images,
          train_labels,
          epochs=10,
          validation_data=(test_images,test_labels),
          callbacks=[cp_callback])  # ì½œë°±ì„ í›ˆë ¨ì— ì „ë‹¬í•©ë‹ˆë‹¤

# ì˜µí‹°ë§ˆì´ì €ì˜ ìƒíƒœë¥¼ ì €ì¥í•˜ëŠ” ê²ƒê³¼ ê´€ë ¨ë˜ì–´ ê²½ê³ ê°€ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
# ì´ ê²½ê³ ëŠ” (ê·¸ë¦¬ê³  ì´ ë…¸íŠ¸ë¶ì˜ ë‹¤ë¥¸ ë¹„ìŠ·í•œ ê²½ê³ ëŠ”) ì´ì „ ì‚¬ìš© ë°©ì‹ì„ ê¶Œì¥í•˜ì§€ ì•Šê¸° ìœ„í•¨ì´ë©° ë¬´ì‹œí•´ë„ ì¢‹ìŠµë‹ˆë‹¤.
```

    2022-02-17 16:49:51.105323: W tensorflow/core/platform/profile_utils/cpu_utils.cc:128] Failed to get CPU frequency: 0 Hz


    Epoch 1/10


    2022-02-17 16:49:51.368642: I tensorflow/core/grappler/optimizers/custom_graph_optimizer_registry.cc:112] Plugin optimizer for device_type GPU is enabled.


    32/32 [==============================] - ETA: 0s - loss: 1.1427 - accuracy: 0.6720
    Epoch 00001: saving model to training_1/cp.ckpt
    32/32 [==============================] - 1s 17ms/step - loss: 1.1427 - accuracy: 0.6720 - val_loss: 0.7174 - val_accuracy: 0.7760
    Epoch 2/10
     1/32 [..............................] - ETA: 0s - loss: 0.5445 - accuracy: 0.8750

    2022-02-17 16:49:52.117317: I tensorflow/core/grappler/optimizers/custom_graph_optimizer_registry.cc:112] Plugin optimizer for device_type GPU is enabled.


    23/32 [====================>.........] - ETA: 0s - loss: 0.4335 - accuracy: 0.8859
    Epoch 00002: saving model to training_1/cp.ckpt
    32/32 [==============================] - 0s 8ms/step - loss: 0.4143 - accuracy: 0.8890 - val_loss: 0.5200 - val_accuracy: 0.8290
    Epoch 3/10
    26/32 [=======================>......] - ETA: 0s - loss: 0.2802 - accuracy: 0.9279
    Epoch 00003: saving model to training_1/cp.ckpt
    32/32 [==============================] - 0s 8ms/step - loss: 0.2809 - accuracy: 0.9280 - val_loss: 0.4814 - val_accuracy: 0.8420
    Epoch 4/10
    26/32 [=======================>......] - ETA: 0s - loss: 0.2033 - accuracy: 0.9531
    Epoch 00004: saving model to training_1/cp.ckpt
    32/32 [==============================] - 0s 8ms/step - loss: 0.2021 - accuracy: 0.9530 - val_loss: 0.4407 - val_accuracy: 0.8560
    Epoch 5/10
    25/32 [======================>.......] - ETA: 0s - loss: 0.1396 - accuracy: 0.9725
    Epoch 00005: saving model to training_1/cp.ckpt
    32/32 [==============================] - 0s 8ms/step - loss: 0.1496 - accuracy: 0.9720 - val_loss: 0.4382 - val_accuracy: 0.8560
    Epoch 6/10
    26/32 [=======================>......] - ETA: 0s - loss: 0.1006 - accuracy: 0.9820
    Epoch 00006: saving model to training_1/cp.ckpt
    32/32 [==============================] - 0s 8ms/step - loss: 0.1018 - accuracy: 0.9810 - val_loss: 0.4350 - val_accuracy: 0.8610
    Epoch 7/10
    26/32 [=======================>......] - ETA: 0s - loss: 0.0784 - accuracy: 0.9868
    Epoch 00007: saving model to training_1/cp.ckpt
    32/32 [==============================] - 0s 8ms/step - loss: 0.0800 - accuracy: 0.9870 - val_loss: 0.4303 - val_accuracy: 0.8710
    Epoch 8/10
    26/32 [=======================>......] - ETA: 0s - loss: 0.0549 - accuracy: 0.9988
    Epoch 00008: saving model to training_1/cp.ckpt
    32/32 [==============================] - 0s 8ms/step - loss: 0.0572 - accuracy: 0.9950 - val_loss: 0.4145 - val_accuracy: 0.8650
    Epoch 9/10
    25/32 [======================>.......] - ETA: 0s - loss: 0.0513 - accuracy: 0.9962
    Epoch 00009: saving model to training_1/cp.ckpt
    32/32 [==============================] - 0s 8ms/step - loss: 0.0513 - accuracy: 0.9960 - val_loss: 0.4254 - val_accuracy: 0.8610
    Epoch 10/10
    23/32 [====================>.........] - ETA: 0s - loss: 0.0391 - accuracy: 1.0000
    Epoch 00010: saving model to training_1/cp.ckpt
    32/32 [==============================] - 0s 8ms/step - loss: 0.0360 - accuracy: 1.0000 - val_loss: 0.4128 - val_accuracy: 0.8710





    <keras.callbacks.History at 0x2a162ee50>




```python
os.listdir(checkpoint_dir)
```




    ['cp.ckpt.data-00000-of-00001', 'checkpoint', 'cp.ckpt.index']



- ë‘ ëª¨ë¸ì´ ë™ì¼í•œ ì•„í‚¤í…ì²˜ë¥¼ ê³µìœ í•˜ê¸°ë§Œ í•œë‹¤ë©´ ë‘ ëª¨ë¸ ê°„ì— ê°€ì¤‘ì¹˜ë¥¼ ê³µìœ í•  ìˆ˜ ìˆë‹¤.
- ë”°ë¼ì„œ ê°€ì¤‘ì¹˜ ì „ìš©ì—ì„œ ëª¨ë¸ì„ ë³µì›í•  ë•Œ ì›ë˜ ëª¨ë¸ê³¼ ë™ì¼í•œ ì•„í‚¤í…ì²˜ë¡œ ëª¨ë¸ì„ ë§Œë“  ë‹¤ìŒ ê°€ì¤‘ì¹˜ë¥¼ ì„¤ì •


```python
# ê¸°ë³¸ ëª¨ë¸ ê°ì²´ë¥¼ ë§Œë“­ë‹ˆë‹¤
model = create_model()

# ëª¨ë¸ì„ í‰ê°€í•©ë‹ˆë‹¤
loss, acc = model.evaluate(test_images,  test_labels, verbose=2)
print("í›ˆë ¨ë˜ì§€ ì•Šì€ ëª¨ë¸ì˜ ì •í™•ë„: {:5.2f}%".format(100*acc))
```

    32/32 - 0s - loss: 2.3495 - accuracy: 0.1340 - 176ms/epoch - 5ms/step
    í›ˆë ¨ë˜ì§€ ì•Šì€ ëª¨ë¸ì˜ ì •í™•ë„: 13.40%


    2022-02-17 16:52:26.824308: I tensorflow/core/grappler/optimizers/custom_graph_optimizer_registry.cc:112] Plugin optimizer for device_type GPU is enabled.


- ì²´í¬í¬ì¸íŠ¸ì—ì„œ ê°€ì¤‘ì¹˜ ë¡œë“œ í›„ ë‹¤ì‹œ ì‹¤í–‰


```python
# ê°€ì¤‘ì¹˜ ë¡œë“œ
model.load_weights(checkpoint_path)

# ëª¨ë¸ ì¬í‰ê°€
loss,acc = model.evaluate(test_images,  test_labels, verbose=2)
print("ë³µì›ëœ ëª¨ë¸ì˜ ì •í™•ë„: {:5.2f}%".format(100*acc))
```

    32/32 - 0s - loss: 0.4128 - accuracy: 0.8710 - 101ms/epoch - 3ms/step
    ë³µì›ëœ ëª¨ë¸ì˜ ì •í™•ë„: 87.10%


#### ì²´í¬í¬ì¸íŠ¸ ì½œë°± ë§¤ê°œë³€ìˆ˜


```python
# íŒŒì¼ ì´ë¦„ì— ì—í¬í¬ ë²ˆí˜¸ë¥¼ í¬í•¨ì‹œí‚µë‹ˆë‹¤(`str.format` í¬ë§·)
checkpoint_path = "training_2/cp-{epoch:04d}.ckpt"
checkpoint_dir = os.path.dirname(checkpoint_path)

# ë‹¤ì„¯ ë²ˆì§¸ ì—í¬í¬ë§ˆë‹¤ ê°€ì¤‘ì¹˜ë¥¼ ì €ì¥í•˜ê¸° ìœ„í•œ ì½œë°±ì„ ë§Œë“­ë‹ˆë‹¤
cp_callback = tf.keras.callbacks.ModelCheckpoint(
    filepath=checkpoint_path,
    verbose=1,
    save_weights_only=True,
    period=5)

# ìƒˆë¡œìš´ ëª¨ë¸ ê°ì²´ë¥¼ ë§Œë“­ë‹ˆë‹¤
model = create_model()

# `checkpoint_path` í¬ë§·ì„ ì‚¬ìš©í•˜ëŠ” ê°€ì¤‘ì¹˜ë¥¼ ì €ì¥í•©ë‹ˆë‹¤
model.save_weights(checkpoint_path.format(epoch=0))

# ìƒˆë¡œìš´ ì½œë°±ì„ ì‚¬ìš©í•˜ì—¬ ëª¨ë¸ì„ í›ˆë ¨í•©ë‹ˆë‹¤
model.fit(train_images,
          train_labels,
          epochs=50,
          callbacks=[cp_callback],
          validation_data=(test_images,test_labels),
          verbose=0)
```

    WARNING:tensorflow:`period` argument is deprecated. Please use `save_freq` to specify the frequency in number of batches seen.


    2022-02-17 17:03:47.143254: I tensorflow/core/grappler/optimizers/custom_graph_optimizer_registry.cc:112] Plugin optimizer for device_type GPU is enabled.
    2022-02-17 17:03:47.447065: I tensorflow/core/grappler/optimizers/custom_graph_optimizer_registry.cc:112] Plugin optimizer for device_type GPU is enabled.



    Epoch 00005: saving model to training_2/cp-0005.ckpt

    Epoch 00010: saving model to training_2/cp-0010.ckpt

    Epoch 00015: saving model to training_2/cp-0015.ckpt

    Epoch 00020: saving model to training_2/cp-0020.ckpt

    Epoch 00025: saving model to training_2/cp-0025.ckpt

    Epoch 00030: saving model to training_2/cp-0030.ckpt

    Epoch 00035: saving model to training_2/cp-0035.ckpt

    Epoch 00040: saving model to training_2/cp-0040.ckpt

    Epoch 00045: saving model to training_2/cp-0045.ckpt

    Epoch 00050: saving model to training_2/cp-0050.ckpt





    <keras.callbacks.History at 0x29d93a280>




```python
os.listdir(checkpoint_dir)
```




    ['cp-0005.ckpt.data-00000-of-00001',
     'cp-0050.ckpt.index',
     'cp-0005.ckpt.index',
     'cp-0050.ckpt.data-00000-of-00001',
     'checkpoint',
     'cp-0020.ckpt.data-00000-of-00001',
     'cp-0000.ckpt.index',
     'cp-0030.ckpt.index',
     'cp-0025.ckpt.data-00000-of-00001',
     'cp-0000.ckpt.data-00000-of-00001',
     'cp-0035.ckpt.index',
     'cp-0010.ckpt.index',
     'cp-0045.ckpt.index',
     'cp-0045.ckpt.data-00000-of-00001',
     'cp-0010.ckpt.data-00000-of-00001',
     'cp-0035.ckpt.data-00000-of-00001',
     'cp-0015.ckpt.index',
     'cp-0040.ckpt.index',
     'cp-0025.ckpt.index',
     'cp-0030.ckpt.data-00000-of-00001',
     'cp-0040.ckpt.data-00000-of-00001',
     'cp-0015.ckpt.data-00000-of-00001',
     'cp-0020.ckpt.index']




```python
latest = tf.train.latest_checkpoint(checkpoint_dir)
latest
```




    'training_2/cp-0050.ckpt'



> **ì°¸ê³ : ê¸°ë³¸ TensorFlow í˜•ì‹ì€ ê°€ì¥ ìµœê·¼ì˜ ì²´í¬í¬ì¸íŠ¸ 5ê°œë§Œ ì €ì¥**


```python
# ìƒˆë¡œìš´ ëª¨ë¸ ê°ì²´ë¥¼ ë§Œë“­ë‹ˆë‹¤
model = create_model()

# ì´ì „ì— ì €ì¥í•œ ê°€ì¤‘ì¹˜ë¥¼ ë¡œë“œí•©ë‹ˆë‹¤
model.load_weights(latest)

# ëª¨ë¸ì„ ì¬í‰ê°€í•©ë‹ˆë‹¤
loss, acc = model.evaluate(test_images,  test_labels, verbose=2)
print("ë³µì›ëœ ëª¨ë¸ì˜ ì •í™•ë„: {:5.2f}%".format(100*acc))
```

    32/32 - 0s - loss: 0.5124 - accuracy: 0.8720 - 170ms/epoch - 5ms/step
    ë³µì›ëœ ëª¨ë¸ì˜ ì •í™•ë„: 87.20%


    2022-02-17 17:05:40.713189: I tensorflow/core/grappler/optimizers/custom_graph_optimizer_registry.cc:112] Plugin optimizer for device_type GPU is enabled.



---
### ì´ íŒŒì¼ë“¤ì€ ë¬´ì—‡ì¸ê°€ìš”?

- ìœ„ì˜ ì½”ë“œëŠ” ì´ì§„ í˜•ì‹ì˜ í›ˆë ¨ëœ ê°€ì¤‘ì¹˜ë§Œ í¬í•¨í•˜ëŠ” ì²´í¬í¬ì¸íŠ¸ í˜•ì‹ì˜ íŒŒì¼ ëª¨ìŒì— ê°€ì¤‘ì¹˜ë¥¼ ì €ì¥í•œë‹¤.
- ì²´í¬ í¬ì¸íŠ¸ì—ëŠ” ë‹¤ìŒì´ ì €ì¥ëœë‹¤.
  - ëª¨ë¸ì˜ ê°€ì¤‘ì¹˜ë¥¼ í¬í•¨í•˜ëŠ” í•˜ë‚˜ ì´ìƒì˜ ìƒ¤ë“œ
  - ì–´ë–¤ ê°€ì¤‘ì¹˜ê°€ ì–´ë–¤ ìƒ¤ë“œì— ì €ì¥ë˜ì–´ ìˆëŠ”ì§€ ë‚˜íƒ€ë‚´ëŠ” ì¸ë±ìŠ¤ íŒŒì¼
- ë‹¨ì¼ ë¨¸ì‹ ì—ì„œ ëª¨ë¸ì„ í›ˆë ¨í•˜ëŠ” ê²½ìš° ì ‘ë¯¸ì‚¬ê°€ .data-00000-of-00001ì¸ í•˜ë‚˜ì˜ ìƒ¤ë“œë¥¼ ê°–ê²Œ ëœë‹¤.

---
### ìˆ˜ë™ìœ¼ë¡œ ê°€ì¤‘ì¹˜ ì €ì¥í•˜ê¸°
- `Model.save_weights` ë©”ì„œë“œë¥¼ ì‚¬ìš©í•˜ì—¬ ìˆ˜ë™ìœ¼ë¡œ ê°€ì¤‘ì¹˜ë¥¼ ì €ì¥
- ê¸°ë³¸ì ìœ¼ë¡œ tf.keras, íŠ¹íˆ save_weightsëŠ” .ckpt í™•ì¥ìê°€ ìˆëŠ” TensorFlow ì²´í¬í¬ì¸íŠ¸ í˜•ì‹ì„ ì‚¬ìš©


```python
# ê°€ì¤‘ì¹˜ë¥¼ ì €ì¥í•©ë‹ˆë‹¤
model.save_weights('./checkpoints/my_checkpoint')

# ìƒˆë¡œìš´ ëª¨ë¸ ê°ì²´ë¥¼ ë§Œë“­ë‹ˆë‹¤
model = create_model()

# ê°€ì¤‘ì¹˜ë¥¼ ë³µì›í•©ë‹ˆë‹¤
model.load_weights('./checkpoints/my_checkpoint')

# ëª¨ë¸ì„ í‰ê°€í•©ë‹ˆë‹¤
loss,acc = model.evaluate(test_images,  test_labels, verbose=2)
print("ë³µì›ëœ ëª¨ë¸ì˜ ì •í™•ë„: {:5.2f}%".format(100*acc))
```

    2022-02-18 09:50:04.928420: I tensorflow/core/grappler/optimizers/custom_graph_optimizer_registry.cc:112] Plugin optimizer for device_type GPU is enabled.


    32/32 - 0s - loss: 0.5124 - accuracy: 0.8720 - 313ms/epoch - 10ms/step
    ë³µì›ëœ ëª¨ë¸ì˜ ì •í™•ë„: 87.20%



---
### ì „ì²´ ëª¨ë¸ ì €ì¥í•˜ê¸°

- model.save ë©”ì„œë“œë¥¼ í˜¸ì¶œí•˜ì—¬ ëª¨ë¸ì˜ êµ¬ì¡°, ê°€ì¤‘ì¹˜, í›ˆë ¨ ì„¤ì •ì„ í•˜ë‚˜ì˜ íŒŒì¼/í´ë”ì— ì €ì¥
- ì›ë³¸ íŒŒì´ì¬ ì½”ë“œê°€ ì—†ì–´ë„ ì‚¬ìš© ê°€ëŠ¥
- ì˜µí‹°ë§ˆì´ì € ìƒíƒœê°€ ë³µì›ë˜ì–´ ì¤‘ì§€í•œ ì‹œì ì—ì„œ í›ˆë ¨ì„ ë‹¤ì‹œ ì‹œì‘í•  ìˆ˜ ìˆìŒ
- ë‘ê°€ì§€ ë‹¤ë¥¸ í˜•ì‹ìœ¼ë¡œ ì €ì¥ ê°€ëŠ¥ (SavedModel, HDF5)
- Tensorflow.jsë‚˜ Tensorflolw Lite ë“±ì—ì„œë„ ëª¨ë¸ì„ ë¡œë“œí•˜ì—¬ ì‚¬ìš© ê°€ëŠ¥

#### SavedModel í¬ë§·
- í˜•ì‹ìœ¼ë¡œ ì €ì¥ëœ ëª¨ë¸ì€ `tf.keras.models.load_model`ì„ ì‚¬ìš©í•˜ì—¬ ë³µì›
- Tensorflow Servingê³¼ í˜¸í™˜


```python
# ìƒˆë¡œìš´ ëª¨ë¸ ê°ì²´ë¥¼ ë§Œë“¤ê³  í›ˆë ¨í•©ë‹ˆë‹¤
model = create_model()
model.fit(train_images, train_labels, epochs=5)

# SavedModelë¡œ ì „ì²´ ëª¨ë¸ì„ ì €ì¥í•©ë‹ˆë‹¤
!mkdir -p saved_model
model.save('saved_model/my_model')
```

    Epoch 1/5
     6/32 [====>.........................] - ETA: 0s - loss: 2.0630 - accuracy: 0.3229

    2022-02-18 09:57:29.318031: I tensorflow/core/grappler/optimizers/custom_graph_optimizer_registry.cc:112] Plugin optimizer for device_type GPU is enabled.


    32/32 [==============================] - 0s 7ms/step - loss: 1.1610 - accuracy: 0.6730
    Epoch 2/5
    32/32 [==============================] - 0s 4ms/step - loss: 0.4282 - accuracy: 0.8870
    Epoch 3/5
    32/32 [==============================] - 0s 4ms/step - loss: 0.2902 - accuracy: 0.9320
    Epoch 4/5
    32/32 [==============================] - 0s 4ms/step - loss: 0.2063 - accuracy: 0.9560
    Epoch 5/5
    32/32 [==============================] - 0s 4ms/step - loss: 0.1629 - accuracy: 0.9650
    WARNING:tensorflow:Unresolved object in checkpoint: (root).optimizer.iter
    WARNING:tensorflow:Unresolved object in checkpoint: (root).optimizer.beta_1
    WARNING:tensorflow:Unresolved object in checkpoint: (root).optimizer.beta_2
    WARNING:tensorflow:Unresolved object in checkpoint: (root).optimizer.decay
    WARNING:tensorflow:Unresolved object in checkpoint: (root).optimizer.learning_rate
    WARNING:tensorflow:A checkpoint was restored (e.g. tf.train.Checkpoint.restore or tf.keras.Model.load_weights) but not all checkpointed values were used. See above for specific issues. Use expect_partial() on the load status object, e.g. tf.train.Checkpoint.restore(...).expect_partial(), to silence these warnings, or use assert_consumed() to make the check explicit. See https://www.tensorflow.org/guide/checkpoint#loading_mechanics for details.
    WARNING:tensorflow:Unresolved object in checkpoint: (root).optimizer.iter
    WARNING:tensorflow:Unresolved object in checkpoint: (root).optimizer.beta_1
    WARNING:tensorflow:Unresolved object in checkpoint: (root).optimizer.beta_2
    WARNING:tensorflow:Unresolved object in checkpoint: (root).optimizer.decay
    WARNING:tensorflow:Unresolved object in checkpoint: (root).optimizer.learning_rate
    WARNING:tensorflow:A checkpoint was restored (e.g. tf.train.Checkpoint.restore or tf.keras.Model.load_weights) but not all checkpointed values were used. See above for specific issues. Use expect_partial() on the load status object, e.g. tf.train.Checkpoint.restore(...).expect_partial(), to silence these warnings, or use assert_consumed() to make the check explicit. See https://www.tensorflow.org/guide/checkpoint#loading_mechanics for details.
    INFO:tensorflow:Assets written to: saved_model/my_model/assets


    2022-02-18 09:57:31.037605: W tensorflow/python/util/util.cc:368] Sets are not currently considered sequences, but this may change in the future, so consider avoiding using them.


- SavedModel í˜•ì‹ì€ protobuf ë°”ì´ë„ˆë¦¬ì™€ TensorFlow ì²´í¬í¬ì¸íŠ¸ë¥¼ í¬í•¨í•˜ëŠ” ë””ë ‰í† ë¦¬


```python
# my_model ë””ë ‰í† ë¦¬
%ls saved_model

# assests í´ë”, saved_model.pb, variables í´ë”
%ls saved_model/my_model
```

    [34mmy_model[m[m/
    [34massets[m[m/            keras_metadata.pb  saved_model.pb     [34mvariables[m[m/


- ì €ì¥ëœ ëª¨ë¸ë¡œë¶€í„° ìƒˆë¡œìš´ ëª¨ë¸ ìƒì„±


```python
new_model = tf.keras.models.load_model('saved_model/my_model')

# ëª¨ë¸ êµ¬ì¡°ë¥¼ í™•ì¸í•©ë‹ˆë‹¤
new_model.summary()
```

    Model: "sequential_5"
    _________________________________________________________________
     Layer (type)                Output Shape              Param #
    =================================================================
     dense_10 (Dense)            (None, 512)               401920

     dropout_5 (Dropout)         (None, 512)               0

     dense_11 (Dense)            (None, 10)                5130

    =================================================================
    Total params: 407,050
    Trainable params: 407,050
    Non-trainable params: 0
    _________________________________________________________________



```python
# ë³µì›ëœ ëª¨ë¸ì„ í‰ê°€í•©ë‹ˆë‹¤
loss, acc = new_model.evaluate(test_images,  test_labels, verbose=2)
print('ë³µì›ëœ ëª¨ë¸ì˜ ì •í™•ë„: {:5.2f}%'.format(100*acc))

print(new_model.predict(test_images).shape)
```

    32/32 - 0s - loss: 0.4517 - accuracy: 0.8550 - 217ms/epoch - 7ms/step


    2022-02-18 10:02:53.156661: I tensorflow/core/grappler/optimizers/custom_graph_optimizer_registry.cc:112] Plugin optimizer for device_type GPU is enabled.


    ë³µì›ëœ ëª¨ë¸ì˜ ì •í™•ë„: 85.50%
    (1000, 10)


    2022-02-18 10:02:53.440760: I tensorflow/core/grappler/optimizers/custom_graph_optimizer_registry.cc:112] Plugin optimizer for device_type GPU is enabled.


#### HDF5 íŒŒì¼ë¡œ ì €ì¥í•˜ê¸°


```python
# ìƒˆë¡œìš´ ëª¨ë¸ ê°ì²´ë¥¼ ë§Œë“¤ê³  í›ˆë ¨í•©ë‹ˆë‹¤
model = create_model()
model.fit(train_images, train_labels, epochs=5)

# ì „ì²´ ëª¨ë¸ì„ HDF5 íŒŒì¼ë¡œ ì €ì¥í•©ë‹ˆë‹¤
# '.h5' í™•ì¥ìëŠ” ì´ ëª¨ë¸ì´ HDF5ë¡œ ì €ì¥ë˜ì—ˆë‹¤ëŠ” ê²ƒì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤
model.save('my_model.h5')
```

    Epoch 1/5
     7/32 [=====>........................] - ETA: 0s - loss: 1.9692 - accuracy: 0.3616

    2022-02-18 10:03:56.196978: I tensorflow/core/grappler/optimizers/custom_graph_optimizer_registry.cc:112] Plugin optimizer for device_type GPU is enabled.


    32/32 [==============================] - 0s 6ms/step - loss: 1.1620 - accuracy: 0.6560
    Epoch 2/5
    32/32 [==============================] - 0s 4ms/step - loss: 0.4278 - accuracy: 0.8780
    Epoch 3/5
    32/32 [==============================] - 0s 4ms/step - loss: 0.2873 - accuracy: 0.9170
    Epoch 4/5
    32/32 [==============================] - 0s 4ms/step - loss: 0.2016 - accuracy: 0.9530
    Epoch 5/5
    32/32 [==============================] - 0s 4ms/step - loss: 0.1544 - accuracy: 0.9680


- .h5 íŒŒì¼ë¡œë¶€í„° ëª¨ë¸ì„ ë‹¤ì‹œ ìƒì„±


```python
# ê°€ì¤‘ì¹˜ì™€ ì˜µí‹°ë§ˆì´ì €ë¥¼ í¬í•¨í•˜ì—¬ ì •í™•íˆ ë™ì¼í•œ ëª¨ë¸ì„ ë‹¤ì‹œ ìƒì„±í•©ë‹ˆë‹¤
new_model = tf.keras.models.load_model('my_model.h5')

# ëª¨ë¸ êµ¬ì¡°ë¥¼ ì¶œë ¥í•©ë‹ˆë‹¤
new_model.summary()
```

    Model: "sequential_6"
    _________________________________________________________________
     Layer (type)                Output Shape              Param #
    =================================================================
     dense_12 (Dense)            (None, 512)               401920

     dropout_6 (Dropout)         (None, 512)               0

     dense_13 (Dense)            (None, 10)                5130

    =================================================================
    Total params: 407,050
    Trainable params: 407,050
    Non-trainable params: 0
    _________________________________________________________________



```python
loss, acc = new_model.evaluate(test_images,  test_labels, verbose=2)
print('ë³µì›ëœ ëª¨ë¸ì˜ ì •í™•ë„: {:5.2f}%'.format(100*acc))
```

    32/32 - 0s - loss: 0.4469 - accuracy: 0.8560 - 172ms/epoch - 5ms/step
    ë³µì›ëœ ëª¨ë¸ì˜ ì •í™•ë„: 85.60%


    2022-02-18 10:05:44.776935: I tensorflow/core/grappler/optimizers/custom_graph_optimizer_registry.cc:112] Plugin optimizer for device_type GPU is enabled.


- ì €ì¥ë˜ëŠ” ë‚´ìš©
  - ê°€ì¤‘ì¹˜ ê°’
  - ëª¨ë¸ êµ¬ì¡°
  - ëª¨ë¸ì˜ í›ˆë ¨ êµ¬ì„±(.compile() ë©”ì„œë“œì— ì „ë‹¬í•˜ëŠ” ë‚´ìš©)
  - ì¡´ì¬í•˜ëŠ” ì˜µí‹°ë§ˆì´ì €ì™€ ê·¸ ìƒíƒœ(í›ˆë ¨ì„ ì¤‘ë‹¨í•œ ê³³ì—ì„œ ë‹¤ì‹œ ì‹œì‘í•  ìˆ˜ ìˆê²Œ í•´ì¤Œ)

> ì²´í¬í¬ì¸íŠ¸ê°€ í˜¸í™˜ë˜ì§€ ì•Šê¸° ë•Œë¬¸ì— ì¼€ë¼ìŠ¤ëŠ” v1.x ì˜µí‹°ë§ˆì´ì €(tf.compat.v1.train)ë¥¼ ì €ì¥í•  ìˆ˜ ì—†ë‹¤.

#### ì‚¬ìš©ì ì •ì˜ ê°ì²´
- HDF5ì™€ SavedModelì˜ ì£¼ìš” ì°¨ì´ì 
  - HDF5ëŠ” ê°ì²´ êµ¬ì„±ì„ ì‚¬ìš©í•˜ì—¬ ëª¨ë¸ ì•„í‚¤í…ì²˜ë¥¼ ì €ì¥
  - SavedModelì€ ì‹¤í–‰ ê·¸ë˜í”„ë¥¼ ì €ì¥
- ë”°ë¼ì„œ SavedModelì€ ì›ë³¸ ì½”ë“œ ì—†ì´ë„ ì„œë¸Œí´ë˜ì‹±ëœ ëª¨ë¸ ë° ì‚¬ìš©ì ì§€ì • ë ˆì´ì–´ì™€ ê°™ì€ ì‚¬ìš©ì ì§€ì • ê°ì²´ë¥¼ ì €ì¥í•  ìˆ˜ ìˆë‹¤.
- ì‚¬ìš©ì ì •ì˜ ê°ì²´ë¥¼ HDF5ë¡œ ì €ì¥í•˜ë ¤ë©´ ë‹¤ìŒ ê³¼ì •ì„ ë”°ë¼ì•¼ í•œë‹¤.
  1. ì´ ê°ì²´ì— get_config ë©”ì„œë“œë¥¼ ì •ì˜í•˜ê³  ì„ íƒì ìœ¼ë¡œ from_config í´ë˜ìŠ¤ ë©”ì„œë“œë¥¼ ì •ì˜í•œë‹¤.
    - get_config(self)ëŠ” ê°ì²´ë¥¼ ë‹¤ì‹œ ìƒì„±í•˜ê¸° ìœ„í•´ í•„ìš”í•œ JSON ì§ë ¬í™”ëœ ë§¤ê°œë³€ìˆ˜ ë”•ì…”ë„ˆë¦¬ë¥¼ ë°˜í™˜í•œë‹¤.
    - from_config(cls, config)ëŠ” get_configì—ì„œ ë°˜í™˜ëœ ì„¤ì •ì„ ì‚¬ìš©í•´ ìƒˆë¡œìš´ ê°ì²´ë¥¼ ë§Œë“ ë‹¤. ê¸°ë³¸ì ìœ¼ë¡œ ì´ í•¨ìˆ˜ëŠ” ì´ ì„¤ì •ì„ ì´ˆê¸°í™” ë©”ì„œë“œì˜ ë§¤ê°œë³€ìˆ˜ë¡œ ì‚¬ìš©í•œë‹¤(return cls(**config)).
  2. ëª¨ë¸ì„ ë¡œë“œí•  ë•Œ ì´ ê°ì²´ë¥¼ custom_objects ë§¤ê°œë³€ìˆ˜ë¡œ ì „ë‹¬í•œë‹¤. ë¬¸ìì—´ í´ë˜ìŠ¤ ì´ë¦„ê³¼ íŒŒì´ì¬ í´ë˜ìŠ¤ë¥¼ ë§¤í•‘í•œ ë”•ì„œë„ˆë¦¬ë¥¼ ë§¤ê°œë³€ìˆ˜ë¡œ ì œê³µí•´ì•¼ í•œë‹¤. ì˜ˆë¥¼ ë“¤ë©´ tf.keras.models.load_model(path, custom_objects={'CustomLayer': CustomLayer})


```python

```
